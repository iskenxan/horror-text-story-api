{"version":3,"sources":["../../../server/rest-handlers/feed/ranking-feed.js"],"names":["getFeed","db","collection","doc","get","then","snapshot","data","posts","updateFeed","update","getPost","postId","post","_","filter","value","key","length","addPostToRankingFeed","rankedFeedItem","feedItems","Object","keys","id","removePostFromRankingFeed","addRanking","feedItem","favoritePoints","favoriteCount","ranking","orderRankedFeedItems","array","map","sortBy","reverse","convertArrayFeedItemsToObject","forEach","keyBy","addReactionToPostRank","reaction","extractedPost","lastIndex","lowestRankingItem","removeFavoriteFromPostRank","addNewCommentToPostRank","addNewFavoriteToPostRank","fetchAndUpdateTimestamp","author","User","getPublished","exists","lastUpdated","checkAndFixTimestamp","fixItems","item","promises","fixItem","Promise","resolve","all","getRankedFeed","items","module","exports"],"mappings":"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","file":"ranking-feed.js","sourcesContent":["import _ from 'lodash';\nimport { db } from '../../firebase';\nimport User from '../../firebase/user';\n\nconst getFeed = () => {\n  return db.collection('ranking-feed').doc('feed').get()\n    .then((snapshot) => {\n      const { posts } = snapshot.data();\n      return posts;\n    });\n};\n\n\nconst updateFeed = (posts) => {\n  return db.collection('ranking-feed').doc('feed').update({\n    posts,\n  });\n};\n\n\nconst getPost = (posts, postId) => {\n  const post = _.filter(posts, (value, key) => {\n    return key === postId;\n  });\n\n  return post.length > 0 ? post[0] : null;\n};\n\n\nconst addPostToRankingFeed = (rankedFeedItem) => {\n  return getFeed()\n    .then((feedItems) => {\n      if (Object.keys(feedItems).length >= 1000) return;\n      feedItems[rankedFeedItem.id] = rankedFeedItem;\n      return updateFeed(feedItems);\n    });\n};\n\n\nconst removePostFromRankingFeed = (postId) => {\n  return getFeed()\n    .then((feedItems) => {\n      const post = getPost(feedItems, postId);\n      if (!post) return;\n\n      delete feedItems[postId];\n      return updateFeed(feedItems);\n    });\n};\n\n\nconst addRanking = (feedItem) => {\n  const favoritePoints = feedItem.favoriteCount || 0;\n  // const commentPoints = feedItem.commentCount ? feedItem.commentCount * 2 : 0;\n  // const ranking = favoritePoints + commentPoints;\n  const ranking = favoritePoints;\n\n  return { ...feedItem, ranking };\n};\n\n\nconst orderRankedFeedItems = (feedItems) => {\n  let array = Object.keys(feedItems).map(key => ({ id: key, ...feedItems[key] }));\n  array = array.map(post => addRanking(post));\n  array = _.sortBy(array, 'ranking');\n  array = _.reverse(array);\n\n  return array;\n};\n\n\nconst convertArrayFeedItemsToObject = (feedItems) => {\n  feedItems.forEach(post => delete post.ranking);\n\n  return _.keyBy(feedItems, 'id');\n};\n\n\nconst addReactionToPostRank = (feedItem, reaction) => {\n  return getFeed()\n    .then((feedItems) => {\n      const extractedPost = getPost(feedItems, feedItem.id);\n      if (extractedPost) {\n        extractedPost[reaction] = extractedPost[reaction]\n          ? extractedPost[reaction] + 1 : 1;\n        return updateFeed(feedItems);\n      }\n      feedItem = addRanking(feedItem);\n      feedItems = orderRankedFeedItems(feedItems);\n      const lastIndex = feedItems.length - 1;\n      const lowestRankingItem = feedItems[lastIndex];\n      if (lowestRankingItem.ranking < feedItem.ranking) {\n        feedItems[lastIndex] = feedItem;\n        feedItems = convertArrayFeedItemsToObject(feedItems);\n\n        return updateFeed(feedItems);\n      }\n    });\n};\n\n\nconst removeFavoriteFromPostRank = (postId) => {\n  return getFeed()\n    .then((posts) => {\n      const post = getPost(posts, postId);\n      if (!post) return;\n\n      post.favoriteCount -= 1;\n\n      updateFeed(posts);\n    });\n};\n\n\nconst addNewCommentToPostRank = (rankedFeedItem) => {\n  return addReactionToPostRank(rankedFeedItem, 'commentCount');\n};\n\n\nconst addNewFavoriteToPostRank = (rankedFeedItem) => {\n  return addReactionToPostRank(rankedFeedItem, 'favoriteCount');\n};\n\n\nconst fetchAndUpdateTimestamp = (feedItem) => {\n  const {\n    author,\n    id,\n  } = feedItem;\n\n  return User.getPublished(author, id).then((doc) => {\n    if (!doc.exists) return;\n    const { lastUpdated } = doc.data();\n    feedItem.lastUpdated = lastUpdated;\n\n    return feedItem;\n  });\n};\n\n\nconst checkAndFixTimestamp = (feedItems) => {\n  const fixItems = _.filter(feedItems, item => item.lastUpdated === 0);\n  const promises = fixItems.map(fixItem => fetchAndUpdateTimestamp(fixItem));\n  if (fixItems.length <= 0) return Promise.resolve();\n  return Promise.all(promises).then(() => {\n    return updateFeed(feedItems);\n  });\n};\n\n\nconst getRankedFeed = () => {\n  let feedItems;\n  return getFeed()\n    .then((items) => {\n      feedItems = items;\n      return checkAndFixTimestamp(feedItems);\n    })\n    .then(() => {\n      return orderRankedFeedItems(feedItems);\n    });\n};\n\n\nmodule.exports = {\n  addPostToRankingFeed,\n  addNewCommentToPostRank,\n  addNewFavoriteToPostRank,\n  getRankedFeed,\n  removePostFromRankingFeed,\n  removeFavoriteFromPostRank,\n};\n"]}