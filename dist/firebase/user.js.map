{"version":3,"sources":["../../server/firebase/user.js"],"names":["User","username","password","hashedPassword","publishedRefs","draftRefs","followers","following","db","collection","doc","get","removeFromFavorite","authorUsername","postId","FieldValue","adminFirestore","firestore","update","delete","then","arrayRemove","addFavoriteReactionId","reactionId","addToFavorite","title","arrayUnion","author","follow","followingUsername","follower","unfollow","unpublish","InvalidArgumentError","post","lastUpdated","Date","getTime","getPublished","exists","ResourceNotFound","data","postActivityId","favorite","comments","set","id","_saveDraftRef","deletePost","savePublished","dialogCount","postCopy","_saveInCollection","snapshot","_savePublishedRef","created","updatePublished","updateKey","updateValue","getDraft","draftId","updateDraft","draft","_updateInDraftsCollection","draftCopy","deleteDraft","saveDraft","ref","characters","dialog","writeToDb","findUserByUsername","Promise","reject","module","exports"],"mappings":"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","file":"user.js","sourcesContent":["/* eslint-disable prefer-destructuring */\nimport adminFirestore from 'firebase-admin';\nimport { db } from './index';\nimport { generateHashedPassword, verifyToken } from '../encrypt';\nimport { InvalidArgumentError, ResourceNotFound } from '../utils/errors';\n\nclass User {\n  constructor(username, password) {\n    this.username = username;\n    this.hashedPassword = generateHashedPassword(password);\n    this.publishedRefs = {};\n    this.draftRefs = {};\n    this.followers = [];\n    this.following = [];\n  }\n\n\n  writeToDb = () => {\n    return User.findUserByUsername(this.username).then((doc) => {\n      if (doc.exists) {\n        return Promise.reject(new InvalidArgumentError('User with the give username already exists'));\n      }\n      return db.collection('users').doc(this.username).set({\n        username: this.username,\n        hashedPassword: this.hashedPassword,\n        publishedRefs: this.publishedRefs,\n        draftRefs: this.draftRefs,\n        followers: this.followers,\n        following: this.following,\n      });\n    });\n  };\n\n\n  static removeFromFavorite = (authorUsername, postId, username) => {\n    const { FieldValue } = adminFirestore.firestore;\n    return db.collection('users').doc(authorUsername).collection('published').doc(postId)\n      .update({\n        [`favorite.${username}`]: FieldValue.delete(),\n      })\n      .then(() => {\n        return db.collection('users').doc(authorUsername).update({\n          [`publishedRefs.${postId}.favorite`]: FieldValue.arrayRemove(username),\n        });\n      })\n      .then(() => {\n        return db.collection('users').doc(username).update({\n          [`favorite.${postId}`]: FieldValue.delete(),\n        });\n      });\n  };\n\n\n  static addFavoriteReactionId = (authorUsername, postId, username, reactionId) => {\n    return db.collection('users').doc(authorUsername).collection('published').doc(postId)\n      .update({\n        [`favorite.${username}.reactionId`]: reactionId,\n      });\n  };\n\n\n  static addToFavorite = (authorUsername, postId, title, username) => {\n    return db.collection('users').doc(authorUsername).collection('published').doc(postId)\n      .update({\n        [`favorite.${username}`]: { username },\n      })\n      .then(() => {\n        return db.collection('users').doc(authorUsername).update({\n          [`publishedRefs.${postId}.favorite`]: adminFirestore.firestore.FieldValue.arrayUnion(username),\n        });\n      })\n      .then(() => {\n        return db.collection('users').doc(username).update({\n          [`favorite.${postId}`]: {\n            author: authorUsername,\n            title,\n          },\n        });\n      });\n  };\n\n\n  static follow = (followingUsername, follower) => {\n    return db.collection('users').doc(follower.username)\n      .update({\n        following: adminFirestore.firestore.FieldValue.arrayUnion(followingUsername),\n      })\n      .then(() => {\n        return db.collection('users').doc(followingUsername).update({\n          followers: adminFirestore.firestore.FieldValue.arrayUnion(follower.username),\n        });\n      });\n  };\n\n\n  static unfollow = (followingUsername, follower) => {\n    return db.collection('users').doc(follower.username)\n      .update({\n        following: adminFirestore.firestore.FieldValue.arrayRemove(followingUsername),\n      })\n      .then(() => {\n        return db.collection('users').doc(followingUsername).update({\n          followers: adminFirestore.firestore.FieldValue.arrayRemove(follower.username),\n        });\n      });\n  };\n\n\n  static findUserByUsername(username) {\n    return db.collection('users').doc(username).get();\n  }\n\n\n  static unpublish = (username, postId) => {\n    if (!username || !postId || username === '' || postId === '') {\n      throw new InvalidArgumentError('Username and post id cannot be empty');\n    }\n    let post = null;\n    const lastUpdated = new Date().getTime();\n    return User.getPublished(username, postId)\n      .then((doc) => {\n        if (!doc.exists) {\n          throw new ResourceNotFound('Post was not found');\n        }\n        post = doc.data();\n        delete post.postActivityId;\n        delete post.favorite;\n        delete post.comments;\n        post.lastUpdated = lastUpdated;\n        return db.collection('users').doc(username).collection('drafts').doc(postId)\n          .set({ ...post });\n      })\n      .then(() => {\n        post.id = postId;\n        return User._saveDraftRef(username, { ...post }, lastUpdated);\n      })\n      .then(() => {\n        return User.deletePost(postId, username);\n      })\n      .then(() => post);\n  };\n\n\n  static getPublished = (username, postId) => {\n    if (!username || !postId || username === '' || postId === '') {\n      throw new InvalidArgumentError('Username and draft id cannot be empty');\n    }\n    return db.collection('users').doc(username).collection('published').doc(postId)\n      .get();\n  };\n\n\n  static savePublished = (post, username) => {\n    if (!post.title || post.title === '') {\n      throw new InvalidArgumentError('Title cannot be empty');\n    }\n    if (post.dialogCount <= 2) {\n      throw new InvalidArgumentError('Post must have at least 3 dialog messages');\n    }\n    const lastUpdated = new Date().getTime();\n    const postCopy = { ...post };\n\n    return User._saveInCollection(username, post, 'published', lastUpdated).then((snapshot) => {\n      postCopy.id = snapshot.id;\n      return User._savePublishedRef(username, { ...postCopy }, lastUpdated);\n    }).then(() => postCopy);\n  };\n\n\n  static _savePublishedRef = (username, post, lastUpdated) => {\n    const created = post.created ? post.created : lastUpdated;\n\n    return db.collection('users').doc(username).update({\n      [`publishedRefs.${post.id}`]: {\n        title: post.title,\n        created,\n        lastUpdated,\n        author: username,\n        id: post.id,\n        favorite: [],\n      },\n    });\n  };\n\n\n  static updatePublished = (username, postId, updateKey, updateValue) => {\n    return db.collection('users').doc(username)\n      .collection('published').doc(postId)\n      .update({\n        [updateKey]: updateValue,\n      });\n  };\n\n  static getDraft = (username, draftId) => {\n    if (!username || !draftId || username === '' || draftId === '') {\n      throw new InvalidArgumentError('Username and draft id cannot be empty');\n    }\n    return db.collection('users').doc(username)\n      .collection('drafts').doc(draftId)\n      .get();\n  };\n\n\n  static updateDraft = (username, draft) => {\n    if (!draft.title || draft.title === '' || !draft.id || draft.id === '') {\n      throw new InvalidArgumentError('Title and id cannot be empty');\n    }\n    const lastUpdated = new Date().getTime();\n    return User._updateInDraftsCollection(username, draft, lastUpdated).then(() => {\n      return User._saveDraftRef(username, draft, lastUpdated).then(() => {\n        draft.lastUpdated = lastUpdated;\n        return draft;\n      });\n    });\n  };\n\n\n  static _updateInDraftsCollection = (username, draft, lastUpdated) => {\n    const draftCopy = { ...draft };\n    delete draftCopy.id;\n    draftCopy.lastUpdated = lastUpdated;\n\n    return db.collection('users').doc(username).collection('drafts').doc(draft.id)\n      .update(draftCopy);\n  };\n\n\n  static deletePost = (postId, username) => {\n    return db.collection('users').doc(username).collection('published').doc(postId)\n      .delete()\n      .then(() => {\n        return db.collection('users').doc(username).update({\n          [`publishedRefs.${postId}`]: adminFirestore.firestore.FieldValue.delete(),\n        });\n      });\n  };\n\n\n  static deleteDraft = (draftId, username) => {\n    return db.collection('users').doc(username).collection('drafts').doc(draftId)\n      .delete()\n      .then(() => {\n        return db.collection('users').doc(username).update({\n          [`draftRefs.${draftId}`]: adminFirestore.firestore.FieldValue.delete(),\n        });\n      });\n  };\n\n\n  static saveDraft = (username, draft) => {\n    if (!draft.title || draft.title === '') {\n      throw new InvalidArgumentError('Title cannot be empty');\n    }\n    const lastUpdated = new Date().getTime();\n    return User._saveInCollection(username, draft, 'drafts', lastUpdated).then((ref) => {\n      const { id } = ref;\n      return User._saveDraftRef(username, { ...draft, id: ref.id }, lastUpdated).then(() => {\n        return {\n          ...draft, id, lastUpdated, author: username,\n        };\n      });\n    });\n  };\n\n\n  static _saveInCollection = (username, post, collection, lastUpdated) => {\n    const created = post.created ? post.created : lastUpdated;\n    const ref = db.collection('users').doc(username).collection(collection).doc();\n    const { id } = ref;\n    return ref.set({\n      title: post.title,\n      characters: post.characters,\n      dialog: post.dialog,\n      dialogCount: post.dialogCount,\n      created,\n      lastUpdated,\n      author: username,\n      favorite: {},\n      id,\n    }).then(() => {\n      return ref;\n    });\n  };\n\n\n  static _saveDraftRef = (username, draft, lastUpdated) => {\n    const created = draft.created ? draft.created : lastUpdated;\n\n    return db.collection('users').doc(username).update({\n      [`draftRefs.${draft.id}`]: {\n        title: draft.title,\n        created,\n        lastUpdated,\n        author: username,\n        favorite: [],\n        id: draft.id,\n      },\n    });\n  };\n}\n\nmodule.exports = User;\n"]}