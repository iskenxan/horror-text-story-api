{"version":3,"sources":["../../server/stream/index.js"],"names":["process","env","STREAM_KEY","STREAM_SECRET","client","stream","connect","location","addPostActivity","username","postId","postTitle","timestamp","userFeed","feed","addActivity","actor","verb","object","foreign_id","removePostActivity","removeActivity","foreignId","followUser","following","timelineFeed","follow","unfollowUser","timelinefeed","unfollow","addNotification","notificationFeed","Date","getTime","addFollowerNotification","followerUsername","getUserClient","userToken","createUserToken","addReaction","authorUsername","type","postActivityId","notifyMaker","userClient","reactions","add","then","reactionResult","removeFavoriteNotification","reactionId","delete","secondResult","console","log","addFavoriteNotification","addCommentNotification","getTimelineFeed","timeLineFeed","get","limit","enrich","counts","result","removePostNotifications","author","getNotificationFeed","mark_seen","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["import stream from 'getstream';\n\nconst { STREAM_KEY, STREAM_SECRET } = process.env;\nconst client = stream.connect(STREAM_KEY, STREAM_SECRET, '46620', { location: 'us-east' });\n\n\nconst addPostActivity = (username, postId, postTitle, timestamp) => {\n  const userFeed = client.feed('user', username);\n  return userFeed.addActivity({\n    actor: username,\n    verb: 'post',\n    object: postId,\n    foreign_id: `post:${postId}`,\n    postTitle,\n    timestamp,\n  });\n};\n\n\nconst removePostActivity = (username, postId) => {\n  const userFeed = client.feed('user', username);\n  return userFeed.removeActivity({ foreignId: `post:${postId}` });\n};\n\n\nconst followUser = (username, following) => {\n  const timelineFeed = client.feed('timeline', username);\n  timelineFeed.follow('user', following);\n};\n\n\nconst unfollowUser = (username, following) => {\n  const timelinefeed = client.feed('timeline', username);\n  timelinefeed.unfollow('user', following);\n};\n\nconst addNotification = (username, actor, verb, foreignId, object) => {\n  const notificationFeed = client.feed('notifications', username);\n  return notificationFeed.addActivity({\n    actor,\n    verb,\n    object,\n    foreign_id: foreignId,\n    timestamp: new Date().getTime(),\n  });\n};\n\n\nconst addFollowerNotification = (username, followerUsername) => {\n  const foreignId = `${followerUsername}-follow-${username}`;\n  return addNotification(username, followerUsername, 'follow', foreignId, foreignId);\n};\n\n\nconst getUserClient = (username) => {\n  const userToken = client.createUserToken(username);\n  return stream.connect(STREAM_KEY, userToken, '46620');\n};\n\n\nconst addReaction = (username, authorUsername, type, postId,\n  postActivityId, notifyMaker = false) => {\n  const userClient = getUserClient(username);\n\n  return userClient.reactions.add(type, postActivityId, {\n    actor: username,\n    timestamp: new Date().getTime(),\n  })\n    .then((reactionResult) => {\n      if (notifyMaker) {\n        addNotification(authorUsername, username, type, postId, postId);\n      }\n      return reactionResult;\n    });\n};\n\n\nconst removeFavoriteNotification = (username, reactionId) => {\n  return client.reactions.delete(reactionId, (secondResult) => {\n    console.log(secondResult);\n  });\n};\n\nconst addFavoriteNotification = (username, authorUsername, postId, postActivityId) => {\n  return addReaction(username, authorUsername, 'like', postId, postActivityId);\n};\n\n\nconst addCommentNotification = (username, authorUsername, postId, postActivityId, notifyMaker) => {\n  return addReaction(username, authorUsername, 'comment', postId, postActivityId, notifyMaker);\n};\n\n\nconst getTimelineFeed = (username) => {\n  const timeLineFeed = client.feed('timeline', username);\n  return timeLineFeed.get({\n    limit: 25,\n    enrich: true,\n    reactions: {\n      counts: true,\n    },\n  }).then((result) => {\n    return result;\n  });\n};\n\n\nconst removePostNotifications = (author, postId) => {\n  const notificationFeed = client.feed('notifications', author);\n  return notificationFeed.removeActivity({ foreignId: postId });\n};\n\n\nconst getNotificationFeed = (username) => {\n  const notificationFeed = client.feed('notifications', username);\n  return notificationFeed.get({ limit: 100, mark_seen: true }).then((result) => {\n    return result;\n  });\n};\n\n\nmodule.exports = {\n  addPostActivity,\n  removePostActivity,\n  addFollowerNotification,\n  addFavoriteNotification,\n  addCommentNotification,\n  followUser,\n  unfollowUser,\n  getTimelineFeed,\n  getNotificationFeed,\n  removeFavoriteNotification,\n  removePostNotifications,\n};\n"]}